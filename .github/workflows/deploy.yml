################################################################################
# ðŸ“¦  CI/CD â€“ Deploy vÃ­a SCP                                         #
# --------------------------------------------------------------------------- #
# â€¢ Sube el repo al VPS por SCP                                                #
# â€¢ Hace backup, rebuild y arranca contenedores vÃ­a SSH                        #
# â€¢ Si falla, avisa por Telegram y ejecuta rollback                            #
# â€¢ Concurrency para que un push no pise a otro                                #
################################################################################

name: DEPLOY

on:
  workflow_run:
    workflows: ["Deploy test"]
    types:
      - completed
  push:
    branches: [main]

# Evita despliegues simultÃ¡neos en la misma rama
concurrency:
  group: main
  cancel-in-progress: true

  ###########################################################################
  # 1. SEGURIDAD - Solo escaneo bÃ¡sico (no requiere construcciÃ³n)           #
  ###########################################################################
  
jobs:
  security-scan:
    runs-on: ubuntu-24.04
    steps:
    - name: ðŸ›Žï¸ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ” Escaneo de seguridad con Trivy (TODO EN UNO)
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: 0  # No falla el workflow, solo reporta
        scanners: 'vuln,secret'  # â¬…ï¸ Escanea vulnerabilidades y secretos
  
  ###########################################################################
  # ðŸ§ª 2. TESTING - Opcional y seguro (no rompe si no hay tests)            #                                                #
  ###########################################################################
  
  tests:
    runs-on: ubuntu-24.04
    needs: security-scan
    defaults:
      run:
        shell: bash
        working-directory: ./api

    steps:
    - name: ðŸ›Žï¸ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: âŽ” Setup Node.js (necesario para NestJS)
      uses: actions/setup-node@v4
      with:
        node-version: '20-alpine'  # âš ï¸ AJUSTAR a la versiÃ³n
        cache: 'npm'
        cache-dependency-path: api/package-lock.json  # âš ï¸ AJUSTAR a la ruta de tu package-lock.json
    - name: ðŸ“¥ Instalar dependencias (actualizar lock file)
      run: npm install
    - name: ðŸ“¥ Instalar dependencias (ci)
      run: npm ci  # o npm install si tienes package-lock.json

    - name: ðŸ—ï¸ Build de la aplicaciÃ³n
      run: npm run build  # Esto ejecuta "nest build"

    - name: ðŸ§ª Ejecutar tests unitarios
      run: npm test -- --passWithNoTests # Ejecuta "jest"

    - name: ðŸ“Š Tests de cobertura
      run: npm run test:cov -- --passWithNoTests  # Ejecuta "jest --coverage"

    # - name: ðŸ” Tests e2e (opcional)
    #   run: npm run test:e2e -- --passWithNoTests  # Si quieres ejecutar end-to-end tests

  ###########################################################################
  # ðŸš€ 3. DEPLOY                                                            #
  ###########################################################################

  deploy:
    needs: tests # Espera las verificaciones de tests
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'push')
    runs-on: ubuntu-24.04
    environment: staging

    steps:
    - name: ðŸ›Žï¸ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ§¹ Eliminar carpeta .git antes de transferir
      run: |
        rm -rf .git
        # Limpieza segura - solo elimina lo innecesario
        find . -name "*.log" -delete 2>/dev/null || true
        find . -name ".DS_Store" -delete 2>/dev/null || true
        echo "âœ… Archivos temporales eliminados"

    - name: ðŸ“¤ Transferir archivos al VPS
      uses: appleboy/scp-action@v1
      with:
        host:     ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        port:     ${{ secrets.SSH_PORT }}
        key:      ${{ secrets.SSH_PRIVATE_KEY }}
        source:   "./"
        target:   "/mnt/Data/control-pase-azumat"
        strip_components: 1

    - name: ðŸš€ Ejecutar despliegue en VPS
      uses: appleboy/ssh-action@v1.2.2
      id: deploy
      with:
        host:     ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key:      ${{ secrets.SSH_PRIVATE_KEY }}
        port:     ${{ secrets.SSH_PORT }}
        script: |
          set -euo pipefail
          PROJECT_DIR="/mnt/Data/control-pase-azumat"
          BACKUP_ROOT="/mnt/Data/control-pase-backups"

          echo "ðŸ” Verificando directorio..."
          ls -la "$PROJECT_DIR" || echo "âš ï¸ Directorio no accesible"

          # ðŸ“Š MÃ‰TRICAS - Inicio de despliegue
          DEPLOY_START=$(date +%s)
          echo "ðŸ Iniciando despliegue a las $(date)"

          # ---------- BACKUP ----------
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BACKUP_DIR="$BACKUP_ROOT/$TIMESTAMP"
          mkdir -p "$BACKUP_DIR"
          echo "ðŸ“¦ Creando backup en $BACKUP_DIR"
          
          # Backup mÃ¡s eficiente
          cd "$PROJECT_DIR"
          tar --exclude='db-data' --exclude='backups' --exclude='node_modules' \
              --exclude='.git' -czf "$BACKUP_DIR/backup.tar.gz" .
          echo "âœ… Backup creado: $BACKUP_DIR/backup.tar.gz"

          # Borrar backups mÃ¡s antiguos de 7 dÃ­as
          find "$BACKUP_ROOT" -name "*.tar.gz" -mtime +7 -delete
          echo "ðŸ—‘ï¸ Backups >7 dÃ­as eliminados"

          # ðŸ³ DESPLIEGUE CON VERIFICACIÃ“N
          echo "ðŸš€ Iniciando despliegue de contenedores..."
          docker-compose down 2>/dev/null || echo "â„¹ï¸ No hay contenedores ejecutÃ¡ndose"
          docker-compose up -d --build
          
          # â±ï¸ Esperar inicializaciÃ³n
          echo "â³ Esperando que los contenedores se inicien..."
          sleep 15

          # ðŸ” VERIFICACIÃ“N DE ESTADO (MEJORADO)
          echo "ðŸ” Verificando estado de los servicios..."
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… Contenedores en ejecuciÃ³n"
            
            # VerificaciÃ³n adicional de salud (adaptar segÃºn tu app)
            if docker-compose logs --tail=10 | grep -i "error"; then
              echo "âš ï¸ Se detectaron errores en logs"
            else
              echo "âœ… No se detectaron errores en logs"
            fi
          else
            echo "âŒ Algunos contenedores no estÃ¡n funcionando"
            docker-compose ps
            exit 1
          fi

          # ðŸ“Š MÃ‰TRICAS - Fin de despliegue
          DEPLOY_END=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START))
          echo "ðŸ“ˆ DuraciÃ³n total: ${DEPLOY_DURATION} segundos"

          # ðŸ§¹ Limpieza conservadora
          docker system prune -f --filter "until=48h"
          echo "ðŸ§¹ Limpieza de Docker completada"

    - name: ðŸ“£ Notificar resultado
      if: always()  # Se ejecuta siempre (Ã©xito o fallo)
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
        COMMIT_URL: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
        WORKFLOW_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          EMOJI="âœ…"
          TEXTO_ESTADO="exitosa"
        else
          EMOJI="âŒ"
          TEXTO_ESTADO="fallida"
        fi

        MSG="$EMOJI *Despliegue $TEXTO_ESTADO - Staging*
        â€¢ *Repo:* ${{ github.repository }}
        â€¢ *Commit:* ${GITHUB_SHA:0:8}
        â€¢ *EjecuciÃ³n:* [Ver detalles]($WORKFLOW_URL)
        â€¢ *Hora:* $(date -u +'%H:%M:%S UTC')

        _Estado del pipeline: ${{ job.status }}_"

        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT" \
          --data-urlencode "text=$MSG" \
          -d parse_mode="Markdown" > /dev/null
